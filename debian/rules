#!/usr/bin/make -f
export DH_VERBOSE=1
IMAGE_NAME ?= rsdk-debian12

%:
	dh $@

override_dh_auto_build:
	@archs="amd64 arm64"; \
	for arch in $$archs; do \
	  imgdir=debian/tmp/usr/share/rsdk-debian12/images/$$arch; \
	  mkdir -p $$imgdir; \
	  if command -v docker >/dev/null 2>&1 && docker buildx version >/dev/null 2>&1; then \
	    echo "Building $(IMAGE_NAME) for platform linux/$$arch using buildx ..."; \
	    docker buildx build --platform=linux/$$arch -t $(IMAGE_NAME):latest -f Dockerfile --output type=tar,dest=$$imgdir/image.tar . || true; \
	  elif command -v docker >/dev/null 2>&1; then \
	    echo "buildx not available, falling back to docker pull/save for $$arch"; \
	    docker pull --platform=linux/$$arch $(IMAGE_NAME) >/dev/null || true; \
	    docker save $(IMAGE_NAME) -o $$imgdir/image.tar || true; \
	  else \
	    if [ -f debian/images/$$arch/image.tar ]; then \
	      cp debian/images/$$arch/image.tar $$imgdir/image.tar; \
	    else \
	      echo "WARNING: no docker and no prebuilt image for $$arch"; \
	    fi; \
	  fi; \
	done
